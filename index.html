<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lust Engine - ThisVid & DarknessPorn</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: #eee; margin: 0; padding: 20px; text-align: center; }
    h1 { color: #ff4081; }
    input { padding: 12px; width: 70%; max-width: 600px; font-size: 18px; border: 2px solid #ff4081; border-radius: 8px; background: #222; color: white; }
    button { padding: 12px 24px; font-size: 18px; background: #ff4081; border: none; color: white; border-radius: 8px; cursor: pointer; margin: 15px; }
    #prefs { margin: 30px auto; max-width: 700px; background: #1a1a1a; padding: 20px; border-radius: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; }
    #status { color: #ffeb3b; margin: 10px; font-weight: bold; }
    footer { margin-top: 50px; font-size: 0.9em; color: #888; }
  </style>
</head>
<body>

  <h1>Lust Engine</h1>
  <p>Recherche anonyme sur ThisVid + DarknessPorn (accessibles sans restriction FR)</p>

  <input type="text" id="searchInput" placeholder="Ton fantasme (ex: amateur french bdsm)" autofocus />
  <button onclick="search()">Rechercher</button>
  <div id="status"></div>
  <div id="results" style="margin: 40px auto; max-width: 1200px; padding: 0 10px;">
  <!-- Les vidéos s'afficheront ici en grille -->
</div>

  <div id="prefs">
    <h3>Préférences (local)</h3>
    <input type="text" id="tagInput" placeholder="milf +3 ou creampie -5" />
    <button onclick="addTag()">Ajouter</button>
    <ul id="tagList"></ul>
    <button onclick="resetPrefs()" style="background:#e74c3c;">Reset tout</button>
  </div>

  <footer>
    100% anonyme · Prefs dans navigateur · Sites : ThisVid & DarknessPorn (pas de geo-block FR)
  </footer>

  <script>
  const STORAGE_KEY = 'lustEnginePrefs';
  let prefs = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};

  function savePrefs() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
    updateList();
  }

  function updateList() {
    document.getElementById('tagList').innerHTML = Object.entries(prefs).map(([tag, w]) => `<li>${tag}: ${w}</li>`).join('');
  }

  function addTag() {
    const val = document.getElementById('tagInput').value.trim().toLowerCase();
    if (!val) return;
    const match = val.match(/^(.+?)\s*([+-]?\d*\.?\d*)$/);
    if (match) {
      prefs[match[1].trim()] = parseFloat(match[2]) || 1;
      savePrefs();
      document.getElementById('tagInput').value = '';
      showStatus('Tag ajouté !');
    } else {
      showStatus('Format invalide (ex: milf +3)');
    }
  }

  function resetPrefs() {
    if (confirm('Reset toutes les préférences ?')) {
      prefs = {};
      localStorage.removeItem(STORAGE_KEY);
      updateList();
      showStatus('Préférences reset !');
    }
  }

  function showStatus(msg) {
    const statusEl = document.getElementById('status');
    statusEl.textContent = msg;
    setTimeout(() => { statusEl.textContent = ''; }, 5000);
  }

  async function search() {
    const query = document.getElementById('searchInput').value.trim();
    if (!query) {
      alert("Entre un fantasme !");
      return;
    }

    let enhanced = query;
    Object.entries(prefs).forEach(([tag, w]) => {
      if (w > 0) enhanced += ` ${tag}`;
    });

    const proxy = 'https://api.allorigins.win/raw?url=';
    const sites = [
      { name: 'ThisVid', url: `https://thisvid.com/search/?q=${encodeURIComponent(enhanced)}` },
      { name: 'DarknessPorn', url: `https://darknessporn.com/search/${encodeURIComponent(enhanced)}/` }
    ];

    showStatus('Recherche via proxy... (peut prendre 5-10s)');

    const allResults = [];

    for (const site of sites) {
      try {
        console.log(`Fetch ${site.name}: ${enhanced}`);
        const res = await fetch(proxy + encodeURIComponent(site.url));
        if (!res.ok) throw new Error(`${site.name} proxy failed: ${res.status}`);
        const html = await res.text();
        console.log(`${site.name} HTML length: ${html.length}`);

        // Parsing amélioré - cible mieux les blocs vidéo (ajusté pour éviter catégories/actrices)
        const results = [];
        // Regex plus stricte : cherche divs avec class contenant "video", "thumb", "item" + img + a href
        const containerRegex = /<div class="[^"]*(video|thumb|item|teaser|block)[^"]*"[^>]*>([\s\S]*?)<\/div>/gi;
        let containerMatch;
        while ((containerMatch = containerRegex.exec(html)) !== null) {
          const block = containerMatch[2];
          const linkMatch = block.match(/<a[^>]*href="([^"]*?)"[^>]*>/i);
          const thumbMatch = block.match(/<img[^>]*src="([^"]*?)"[^>]*>/i) || block.match(/<img[^>]*data-src="([^"]*?)"[^>]*>/i);
          const titleMatch = block.match(/alt="([^"]*)"[^>]*>/i) || block.match(/title="([^"]*)"[^>]*>/i) || block.match(/<h[1-6][^>]*>([^<]*?)<\/h[1-6]>/i);

          if (linkMatch && thumbMatch) {
            let link = linkMatch[1];
            if (link.startsWith('/')) {
              link = (site.name === 'ThisVid' ? 'https://thisvid.com' : 'https://darknessporn.com') + link;
            }
            const thumb = thumbMatch[1] || 'https://via.placeholder.com/220x150?text=No+Thumb';
            const title = (titleMatch ? titleMatch[1] : 'Sans titre').trim();
            results.push({ title, thumb, link });
          }
        }

        allResults.push(...results);
        console.log(`${site.name} résultats extraits: ${results.length}`);
      } catch (e) {
        console.error(`Erreur ${site.name}:`, e);
        showStatus(`Erreur sur ${site.name}: ${e.message}`);
      }
    }

    displayResults(allResults);
  }

  function displayResults(videos) {
    const container = document.getElementById('results');
    container.innerHTML = '';

    if (videos.length === 0) {
      container.innerHTML = '<p style="color:#ff9800; font-size:18px; text-align:center;">Aucun résultat extrait (regex ou contenu JS-loaded). Essaie un mot-clé plus spécifique ou option liens directs.</p>';
      showStatus('Pas de previews trouvées');
      return;
    }

    let html = '<h2 style="text-align:center; color:#ff4081; margin-bottom:20px;">Résultats boostés</h2>';
    html += '<div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:20px;">';

    videos.forEach(v => {
      const thumb = v.thumb || 'https://via.placeholder.com/220x150?text=No+Thumb';
      const title = v.title || 'Sans titre';
      const link = v.link || '#';
      html += `
        <div style="background:#1a1a1a; border-radius:10px; overflow:hidden; box-shadow:0 4px 8px rgba(0,0,0,0.5);">
          <a href="${link}" target="_blank" style="text-decoration:none; color:inherit; display:block;">
            <img src="${thumb}" alt="${title}" style="width:100%; height:auto; display:block;" 
                 onerror="this.src='https://via.placeholder.com/220x150?text=Thumb+Error';">
            <div style="padding:10px; font-size:14px; line-height:1.4;">${title}</div>
          </a>
        </div>`;
    });

    html += '</div>';
    container.innerHTML = html;
    showStatus(`Affiché ${videos.length} previews !`);
  }

  // Init
  updateList();
</script>

</body>
</html>
